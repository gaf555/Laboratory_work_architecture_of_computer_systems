# Лабораторная работа № 3. Использование ассемблерных вставок на С++

## Навигация

1. [Назад (Отладка кода)](https://github.com/konsilerinos/ACS-labs/blob/main/Lab_2/Lab_2.md)
2. [На главную](https://github.com/konsilerinos/ACS-labs)
3. [Вперёд (Модули и функции на ассемблере)](https://github.com/konsilerinos/ACS-labs/blob/main/Lab_4/Lab_4.md)

## Цель

Научиться вставлять в программы на языке высокого уровня ассемблерные фрагменты

## Задачи

1. Реализуйте расчёт беззнакового целочисленного выражения как ассемблерную вставку в программу на C/C++, помещая временные значения в регистры общего назначения `A`, `B`, `C` (в зависимости от разрядности данных — `eax`, `ecx`, `edx` или `rax`, `rcx`, `rdx`) : `z = (x + 79) / y` и `w = (x + 79) % y`
2. Реализовать задание 1, передав вставке в качестве входных параметров не значения `x` и `y`, а указатели `p = &x` и `q = &y`
3. Реализовать задание 1, неиспользуя в тексте вставки конкретных имён регистров (для размещения параметров в нужных регистрах использовать ограничения)
4. На языке С/C++ выделить память под массив (статический) из целых чисел и инициализировать нулями. Записать значение `x != 0` для элемента по заданному индексу
5. Реализовать для заданного элемента массива запись значения `FF` в старший байт элемента
  
## Отчёт

| Номер задачи | Ссылка на файл                                                                        |
| ------------ | ------------------------------------------------------------------------------------- |
| 1            | [Task-1.c](https://github.com/konsilerinos/ACS-labs/blob/main/Lab_3/Sources/Task-1.c) |
| 2            | [Task-2.c](https://github.com/konsilerinos/ACS-labs/blob/main/Lab_3/Sources/Task-2.c) |
| 3            | [Task-3.c](https://github.com/konsilerinos/ACS-labs/blob/main/Lab_3/Sources/Task-3.c) |
| 4            | [Task-4.c](https://github.com/konsilerinos/ACS-labs/blob/main/Lab_3/Sources/Task-4.c) |
| 5            | [Task-5.c](https://github.com/konsilerinos/ACS-labs/blob/main/Lab_3/Sources/Task-5.c) |

### Задание 1. Ассемблерные вставки
```C++
// z = (x + 79) / y
asm
(
    "movl    %[x], %%eax\n"
    "addl    $79, %%eax\n"
    "movl    %[y], %%ecx\n"
    "cltd\n"
    "idivl   %%ecx\n"
    "movl    %%eax, %[z]\n"
    :[z]"=rm"(z)
    :[x]"g"(x), [y]"g"(y), "[z]"(z)
    : "cc", "%eax", "%ecx"

);
```
```C++
// w = (x + 79) % y
asm
(
    "movl   %[x], %%eax\n"
    "addl   $79, %%eax\n"
    "cltd\n"
    "idivl  %[y]\n"
    "movl   %%edx, %[w]\n"
    :[w]"=rm"(w)
    :[x]"g"(x), [y]"g"(y), "[w]"(w)
    : "cc"
);
```

### Задание 2. Ассемблерная вставка
```C++

```

### Задание 3. Ассемблерная вставка
```C++
 asm(
        "movl $79,%%eax\n"
        "addl %2,%%eax\n"
        "cdq\n"
        "idiv %3\n"
        "movl %%eax , %0\n"
        "movl %%edx , %1"
        :"+r"(w), "+r"(z)
        : "r"(x), "r"(y)
        : "cc","%eax" ,"%edx"
    );
```

### Задание 4. Ассемблерная вставка
```C++
// mas[k] = x
asm
(
    "movl	-84(%rbp), %edx\n"
    "movl	-88(%rbp), %ecx\n"
    "movq	-80(%rbp), %rax\n"
    "movslq	%edx, %rdx\n"
    "movl	%ecx, (%rax,%rdx,4)\n"
    ::: "cc", "%edx", "%ecx", "%rax"
);
```

### Задание 5. Ассемблерная вставка
```C++

```

## Контрольные вопросы

### 1. Каким ключевым словом открывается ассемблерная вставка?

Ассемблерная вставка открывается ключевым словом ```asm```

### 2. Где описываются выходные параметры ассемблерных вставок расширенного синтаксиса GCC? Что означают символы =, =&, + в начале строки ограничений выходного параметра?

```
asm [volatile] (
    "команды␣и␣директивы␣ассемблера"
    "как␣последовательная␣текстовая␣строка"
    : [<выходные параметры>] 
    : [<входные параметры>] 
    : [<перезаписываемые регистры>]
);
```

1. Символ `+` в строке расположения указывает на то, что данный параметр является не чисто выходным, а модифицируемым
2. `=` и `=&` описывают ограничения на размещения операнда

### 3. Где описываются входные параметры?

```
asm [volatile] (
    "команды␣и␣директивы␣ассемблера"
    "как␣последовательная␣текстовая␣строка"
    : [<выходные параметры>] 
    : [<входные параметры>] 
    : [<перезаписываемые регистры>]
);
```

### 4. Где указывается список `clobbers` перезаписываемых во вставке регистров (кроме параметров)? Какая строка соответствуют изменению флагов `flags`? Какая строка соответствуют изменению памяти (кроме параметров)?

```
asm [volatile] (
    "команды␣и␣директивы␣ассемблера"
    "как␣последовательная␣текстовая␣строка"
    : [<выходные параметры>] 
    : [<входные параметры>] 
    : [<перезаписываемые регистры>]
);
```

### 5. Какое ключевое слово нужно указать после asm, чтобы запретить компилятору оптимизировать вставку?

Ключевое слово `volatile`

### 6. Какое ключевое слово нужно указать после asm, чтобы показать, что управление из вставки может передаваться на ту или иную метку C/C++ (зато у этой вставки нет выходных параметров)?

Ключевое слово `goto`

### 7. Какие вы знаете регистры общего назначения x86 и x86/64?

1. eax/ax/ah/al;
2. ebx/bx/bh/bl;
3. edx/dx/dh/dl;
4. ecx/cx/ch/cl;
5. ebp/bp;
6. esi/si;
7. edi/di;
8. esp/sp.

### 8. Какие вы знаете команды ассемблера x86?

![изображение](https://user-images.githubusercontent.com/78896451/137224261-e3f95ea3-402f-4844-8810-e30df06f55f8.png)
![изображение](https://user-images.githubusercontent.com/78896451/137224305-d180b6ba-b4f8-47a2-9569-4cd3c2dee2ba.png)
